nextflow_function {
    /*
    The following tests are for the functions in the main.nf script
    They are tested using the --verbose argument
    */

    name "Test function phaseimpute"
    script "../main.nf"
    tag "function"

    test ("Test getFileExtension") {
        function "getFileExtension"
        tag "getFileExtension"
        when {
            function {
                """
                input[0] = file(params.pipelines_testdata_base_path + "hum_data/panel/chr21/1000GP.chr21.s.norel.vcf.gz", checkIfExists: true)
                """
            }
        }
        then {
            assertAll(
                { assert function.success },
                { assert function.result == "vcf" }
            )
        }
    }

    test ("Test getFileExtension non empty list") {
        function "getFileExtension"
        tag "getFileExtension"
        when {
            function {
                """
                input[0] = [
                    file(params.pipelines_testdata_base_path + "hum_data/panel/chr21/1000GP.chr21.s.norel.vcf.gz", checkIfExists: true),
                    "test.myfile.txt.gz",
                    new URL("https://example.com/data.tar.gz"),
                    new URL("https://example.com/subsite/data.vcf"),
                    nextflow.file.http.XPath.get('http://www.nextflow.io/a/b/c.txt')
                ]
                """
            }
        }
        then {
            assertAll(
                { assert function.success },
                { assert function.result == ['vcf', 'txt', 'tar', 'vcf', 'txt'] },
                { assert snapshot(function.result).match() }
            )
        }
    }

    test ("Test getFileExtension empty list") {
        function "getFileExtension"
        tag "getFileExtension"
        when {
            function {
                """
                input[0] = []
                """
            }
        }
        then {
            assertAll(
                { assert function.success },
                { assert function.result == [] }
            )
        }
    }

    test("Test checkFileIndex no error with empty channel") {
        function "checkFileIndex"
        tag "checkFileIndex"
        when {
            function {
                """
                input[0] = Channel.fromList([
                    [[], [], []],
                    [[id: "input"], file("input.vcf"), file("input.csi")],
                    [[], [], []],
                    [[id: "input3"], file("input3.bcf"), file("input3.csi")],
                    [[], [], []],
                    [[id: "input5"], file("input5.vcf.gz"), file("input5.csi")],
                    [[], [], []],
                    [[id: "input7"], file("input7.bam"), file("input5.bai")],
                    [[], [], []],
                    [[id: "input9"], file("input9.fa"), file("input9.fai")],
                    [[], [], []]
                ])
                """
            }
        }
        then {
            assert function.success
            assert snapshot(function.result).match()
        }
    }

    test("Test checkFileIndex no error") {
        function "checkFileIndex"
        tag "checkFileIndex"
        when {
            function {
                """
                input[0] = Channel.fromList([
                    [[id: "input"], file("input.vcf"), file("input.csi")],
                    [[id: "input2"], file("input2.vcf"), file("input2.tbi")],
                    [[id: "input3"], file("input3.bcf"), file("input3.csi")],
                    [[id: "input4"], file("input4.bcf"), file("input4.tbi")],
                    [[id: "input5"], file("input5.vcf.gz"), file("input5.csi")],
                    [[id: "input6"], file("input6.vcf.gz"), file("input6.tbi")],
                    [[id: "input7"], file("input7.bam"), file("input7.bai")],
                    [[id: "input7"], file("input8.bam"), file("input8.csi")],
                    [[id: "input8"], file("input9.cram"), file("input9.crai")],
                    [[id: "input9"], file("input10.fa"), file("input10.fai")],
                    [[id: "input10"], file("input11.fa"), file("input111.fai")]
                ])
                """
            }
        }
        then {
            assert function.success
        }
    }

    test("Test checkFileIndex bam bai") {
        function "checkFileIndex"
        tag "checkFileIndex"
        when {
            function {
                """
                input[0] = Channel.fromList([
                    [[id: "input7"], file("input7.bam"), file("input5.crai")],
                    [[id: "input6"], file("input6.vcf.gz"), file("input6.tbi")],
                    [[id: "input8"], file("input8.bam"), file("input8.bai")]
                ])
                """
            }
        }
        then {
            assert function.failed
            assert function.stdout.contains("[id:input7]: Index file for .bam must have the extension .bai or .csi")
        }
    }

    test("Test checkFileIndex cram crai") {
        function "checkFileIndex"
        tag "checkFileIndex"
        when {
            function {
                """
                input[0] = Channel.fromList([
                    [[id: "input7"], file("input7.cram"), file("input7.tbi")],
                    [[id: "input6"], file("input6.vcf.gz"), file("input6.tbi")],
                    [[id: "input8"], file("input8.bam"), file("input8.bai")]
                ])
                """
            }
        }
        then {
            assert function.failed
            assert function.stdout.contains("[id:input7]: Index file for .cram must have the extension .crai")
        }
    }

    test("Test checkFileIndex bcf csi") {
        function "checkFileIndex"
        tag "checkFileIndex"
        when {
            function {
                """
                input[0] = Channel.fromList([
                    [[id: "input7"], file("input7.bcf"), file("input7.txt")],
                    [[id: "input6"], file("input6.vcf.gz"), file("input6.tbi")],
                    [[id: "input8"], file("input8.bam"), file("input8.bai")]
                ])
                """
            }
        }
        then {
            assert function.failed
            assert function.stdout.contains("[id:input7]: Index file for .vcf, .vcf.gz and .bcf must have the extension .tbi or .csi")
        }
    }

    test("Test checkFileIndex vcf csi") {
        function "checkFileIndex"
        tag "checkFileIndex"
        when {
            function {
                """
                input[0] = Channel.fromList([
                    [[id: "input7"], file("input7.vcf"), file("input7.bai")],
                    [[id: "input6"], file("input6.vcf.gz"), file("input6.tbi")],
                    [[id: "input8"], file("input8.bam"), file("input8.bai")]
                ])
                """
            }
        }
        then {
            assert function.failed
            assert function.stdout.contains("[id:input7]: Index file for .vcf, .vcf.gz and .bcf must have the extension .tbi or .csi")
        }
    }

    test("Test checkFileIndex vcf.gz csi") {
        function "checkFileIndex"
        tag "checkFileIndex"
        when {
            function {
                """
                input[0] = Channel.fromList([
                    [[id: "input7"], file("input7.vcf.gz"), file("input7.bai")],
                    [[id: "input6"], file("input6.vcf.gz"), file("input6.tbi")],
                    [[id: "input8"], file("input8.bam"), file("input8.bai")]
                ])
                """
            }
        }
        then {
            assert function.failed
            assert function.stdout.contains("[id:input7]: Index file for .vcf, .vcf.gz and .bcf must have the extension .tbi or .csi")
        }
    }

    test("Test checkFileIndex fa fai") {
        function "checkFileIndex"
        tag "checkFileIndex"
        when {
            function {
                """
                input[0] = Channel.fromList([
                    [[id: "input7"], file("input7.fa"), file("input7.tbi")],
                    [[id: "input6"], file("input6.vcf.gz"), file("input6.tbi")],
                    [[id: "input8"], file("input8.bam"), file("input8.bai")]
                ])
                """
            }
        }
        then {
            assert function.failed
            assert function.stdout.contains("[id:input7]: Index file for .fa and .fasta must have the extension .fai")
        }
    }

    test("Test checkFileIndex fasta fai") {
        function "checkFileIndex"
        tag "checkFileIndex"
        when {
            function {
                """
                input[0] = Channel.fromList([
                    [[id: "input7"], file("input7.fasta"), file("input6.fia")],
                    [[id: "input6"], file("input6.vcf.gz"), file("input6.tbi")],
                    [[id: "input8"], file("input8.bam"), file("input8.bai")]
                ])
                """
            }
        }
        then {
            assert function.failed
            assert function.stdout.contains("[id:input7]: Index file for .fa and .fasta must have the extension .fai")
        }
    }

    test("Test Function exportCsv") {
        function "exportCsv"
        tag "exportCsv"
        when {
            params {
                outdir = "results"
            }
            function {
                """
                // define inputs of the function here. Example:
                input[0] = Channel.of( [ [id:'test'], [2:"vcf",3:"index"], file("test1.vcf"), file("test2.csi") ] )
                input[1] = ["id"]
                input[2] = "id,vcf,index"
                input[3] = "impute.csv"
                input[4] = "imputation/csv"
                """
            }
        }

        then {
            with(function) {
                assert success
                assert snapshot(result).match()
            }
        }
    }

    test ("Test checkMetaChr") {
        function "checkMetaChr"
        tag "checkMetaChr"
        when {
            function {
                """
                input[0] = Channel.of([["chr1", "chr2", "chr3", "chr4", "chr5", "chr6", "chr7", "chr8", "chr9", "chr10", "chrX" ]])
                input[1] = Channel.of([["chr1", "chr2", "chr3", "chr4", "chr5", "chr6", "chr7", "chr8", "chr9", "chr10", "chrX" ]])
                input[2] = "test"
                """
            }
        }
        then {
            assert function.success
        }
    }

    test ("Test checkMetaChr warning") {
        function "checkMetaChr"
        tag "checkMetaChr"
        when {
            function {
                """
                input[0] = Channel.of([["chr1", "chr2", "chr3", "chr4", "chr5", "chr6", "chr7", "chr8", "chr9", "chr10", "chrX", "chrY" ]])
                input[1] = Channel.of([["chr1", "chr2", "chr3", "chr4", "chr5", "chr6", "chr7", "chr8", "chr9", "chr10", "chrX" ]])
                input[2] = "test"
                """
            }
        }
        then {
            assertAll (
                { assert function.success },
                { assert snapshot(
                    check_stdout(function.stdout)
                ).match() },
                { assert function.stdout.contains("WARN: Chr : [chrY] is missing from test") }
            )
        }
    }

    test ("Test validateInputBatchTools vcf only for glimpse") {
        function "validateInputBatchTools"
        tag "validateInputBatchTools"
        when {
            function {
                """
                input[0] = Channel.of("A")
                input[1] = 60
                input[2] = "vcf.gz"
                input[3] = ["glimpse2", "quilt"]
                """
            }
        }
        then {
            assertAll (
                { assert function.failed },
                { assert snapshot(
                    check_stdout(function.stdout)
                ).match() }
            )
        }
    }

    test ("Test validateInputBatchTools only one vcf") {
        function "validateInputBatchTools"
        tag "validateInputBatchTools"
        when {
            function {
                """
                input[0] = Channel.of("A", "B", "C", "D", "E")
                input[1] = 60
                input[2] = "vcf.gz"
                input[3] = ["glimpse2", "glimpse1"]
                """
            }
        }
        then {
            assertAll (
                { assert function.failed },
                { assert snapshot(
                    check_stdout(function.stdout)
                ).match() }
            )
        }
    }

    test ("Test validateInputBatchTools error batch") {
        function "validateInputBatchTools"
        tag "validateInputBatchTools"
        when {
            function {
                """
                input[0] = Channel.of(0..150)
                input[1] = 60
                input[2] = "cram"
                input[3] = ["glimpse1", "quilt"]
                """
            }
        }
        then {
            assertAll (
                { assert function.failed },
                { assert snapshot(
                    check_stdout(function.stdout)
                ).match() }
            )
        }
    }

    test ("Test validateInputBatchTools success batch") {
        function "validateInputBatchTools"
        tag "validateInputBatchTools"
        when {
            function {
                """
                input[0] = Channel.of(0..150)
                input[1] = 60
                input[2] = "cram"
                input[3] = ["quilt", "glimpse2"]
                """
            }
        }
        then {
            assertAll (
                { assert function.success },
                { assert snapshot(check_stdout(function.stdout)).match() }
            )
        }
    }

    test ("Test validatePosfileTools good file") {
        function "validatePosfileTools"
        tag "validatePosfileTools"
        when {
            function {
                """
                input[0] = channel.of([
                    [id: "test"], [], [], [], [],
                    file(params.pipelines_testdata_base_path + "hum_data/panel/chr21/1000GP.chr21.posfile", checkIfExists: true)
                ])
                input[1] = "stitch"
                input[2] = "impute"
                input[3] = "bam"
                """
            }
        }
        then {
            assertAll (
                { assert function.success }
            )
        }
    }

    test ("Test validatePosfileTools good compressed file") {
        function "validatePosfileTools"
        tag "validatePosfileTools"
        when {
            function {
                """
                input[0] = channel.of([
                    [id: "test"], [], [], [], [],
                    file(params.pipelines_testdata_base_path + "hum_data/panel/chr21/1000GP.chr21.posfile.gz", checkIfExists: true)
                ])
                input[1] = "stitch"
                input[2] = "impute"
                input[3] = "bam"
                """
            }
        }
        then {
            assertAll (
                { assert function.success }
            )
        }
    }

    test ("Test validatePosfileTools validate with file missing posfile") {
        function "validatePosfileTools"
        tag "validatePosfileTools"
        when {
            function {
                """
                input[0] = channel.of([
                    [id: "test"],
                    file(params.pipelines_testdata_base_path + "hum_data/panel/chr21/1000GP.chr21.sites.vcf.gz", checkIfExists: true),
                    file(params.pipelines_testdata_base_path + "hum_data/panel/chr21/1000GP.chr21.sites.vcf.gz.csi", checkIfExists: true),
                    [], [],
                    []
                ])
                input[1] = "glimpse2"
                input[2] = "validate"
                input[3] = "bam"
                """
            }
        }
        then {
            assertAll (
                { assert function.failed },
                { assert function.stdout.join('\n').contains(
                    "You have not provided a posfile and you've requested to use the validation step with bam files."
                ) }
            )
        }
    }

    test ("Test validatePosfileTools no posfile") {
        function "validatePosfileTools"
        tag "validatePosfileTools"
        when {
            function {
                """
                input[0] = channel.of( [[id: "test"], [], [], [], [], []] )
                input[1] = "glimpse2"
                input[2] = "impute"
                input[3] = "bam"
                """
            }
        }
        then {
            assertAll (
                { assert function.success }
            )
        }
    }

    test ("Test validatePosfileTools wrong file") {
        function "validatePosfileTools"
        tag "validatePosfileTools"
        when {
            function {
                """
                input[0] = channel.of([
                    [id: "test"], [], [], [], [],
                    file(params.pipelines_testdata_base_path + "hum_data/panel/chr21/1000GP.chr21.posfile.stitch", checkIfExists: true)
                ])
                input[1] = "stitch"
                input[2] = "impute"
                input[3] = "bam"
                """
            }
        }
        then {
            assertAll (
                { assert function.failed },
                { assert function.stdout.join('\n').contains(
                    'ERROR ~ Expected 3 columns in 1000GP.chr21.posfile.stitch, found 4 in line: chr21\t16570070\tC\tG.'
                ) }
            )
        }
    }

    test ("Test getRegionFromFai with all") {
        function "getRegionFromFai"
        tag "getRegionFromFai"
        when {
            function {
                """
                input[0] = "all"
                input[1] = Channel.of([
                    [genome:"GRCh37"],
                    file(params.pipelines_testdata_base_path + "/hum_data/reference_genome/GRCh38.s.fa.gz", checkIfExists: true),
                    file(params.pipelines_testdata_base_path + "/hum_data/reference_genome/GRCh38.s.fa.gz.fai", checkIfExists: true)
                ])
                """
            }
        }

        then {
            assertAll(
                { assert function.success },
                { assert snapshot(
                    function.result
                ).match() }
            )
        }
    }

    test ("Test getRegionFromFai with specified chr") {
        function "getRegionFromFai"
        tag "getRegionFromFai"
        when {
            function {
                """
                input[0] = "chr22"
                input[1] = Channel.of([
                    [genome:"GRCh37"],
                    file(params.pipelines_testdata_base_path + "/hum_data/reference_genome/GRCh38.s.fa.gz", checkIfExists: true),
                    file(params.pipelines_testdata_base_path + "/hum_data/reference_genome/GRCh38.s.fa.gz.fai", checkIfExists: true)
                ])
                """
            }
        }

        then {
            assertAll(
                { assert function.success },
                { assert snapshot(
                    function.result
                ).match() }
            )
        }
    }

    test ("Test getRegionFromFai with specified region without fasta") {
        function "getRegionFromFai"
        tag "getRegionFromFai"
        when {
            function {
                """
                input[0] = "chr22:0-4000"
                input[1] = Channel.of([[], [], []])
                """
            }
        }

        then {
            assertAll(
                { assert function.success },
                { assert snapshot(
                    function.result
                ).match() }
            )
        }
    }

    test ("Test getRegionFromFai with an error") {
        function "getRegionFromFai"
        tag "getRegionFromFai"
        when {
            function {
                """
                input[0] = "chr22:0-4000:4648"
                input[1] = Channel.of([[],[],[]])
                """
            }
        }

        then {
            assertAll(
                { assert function.failed },
                { assert snapshot(
                    check_stdout(function.stdout)
                ).match() }
            )
        }
    }

    test ("Test toolBibliographyText - simulate only") {
        function "toolBibliographyText"
        tag "toolBibliographyText"
        when {
            params {
                outdir = "results"
                steps = "simulate"
                tools = null
            }
            function {
                """
                """
            }
        }

        then {
            assertAll(
                { assert function.success },
                { assert snapshot(function.result).match() }
            )
        }
    }
    test ("Test toolBibliographyText - all tools and steps") {
        function "toolBibliographyText"
        tag "toolBibliographyText"
        when {
            params {
                outdir = "results"
                steps = "all"
                tools = "glimpse1,glimpse2,stitch,quilt,beagle5,minimac4"
            }
            function {
                """
                """
            }
        }

        then {
            assertAll(
                { assert function.success },
                { assert snapshot(function.result).match() }
            )
        }
    }
    test ("Test toolCitationText - panelprep only") {
        function "toolCitationText"
        tag "toolCitationText"
        when {
            params {
                outdir = "results"
                steps = "panelprep"
                tools = null
            }
            function {
                """
                """
            }
        }

        then {
            assertAll(
                { assert function.success },
                { assert ["Beagle5", "Minimac4", "STITCH", "QUILT", "vcflib", "SHAPEIT5", "Tabix", "SAMtools"].every { !function.result.contains(it) } },
                { assert ["BCFtools", "GLIMPSE", "GLIMPSE2", "MultiQC"].every { function.result.contains(it) } },
                { assert snapshot(function.result).match() }
            )
        }
    }
    test ("Test toolCitationText - all tools and steps") {
        function "toolCitationText"
        tag "toolCitationText"
        when {
            params {
                outdir = "results"
                steps = "all"
                tools = "glimpse1,glimpse2,stitch,quilt,beagle5,minimac4"
                normalize = true
                phase = true
                remove_samples = "sample1,sample2"
                compute_freq = true
            }
            function {
                """
                """
            }
        }

        then {
            assertAll(
                { assert function.success },
                { assert [
                    "Beagle5", "Minimac4", "STITCH", "QUILT",
                    "vcflib", "SHAPEIT5", "Tabix", "SAMtools",
                    "BCFtools", "GLIMPSE", "GLIMPSE2", "MultiQC"
                ].every { function.result.contains(it) } },
                { assert snapshot(function.result).match() }
            )
        }
    }
}

def check_stdout(function_stdout) {
    function_stdout[2..-1]
        .findAll { !it.matches(/.*Nextflow [0-9]+\.[0-9]+\.[0-9]+ is available.*/) }
}
